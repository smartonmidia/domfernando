<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Painel de Chamadas</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e8f0fe;
            overflow: hidden;
        }
        
        #cabecalho {
            height: 10vh;
            background: #003a5f;
            display: flex;
            align-items: center;
            padding: 0 30px;
            box-sizing: border-box;
        }
        
        #cabecalho img {
            height: 70%;
        }
        
        #main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: 80vh;
            width: 100vw;
        }
        
        #ladoEsquerdo {
            position: relative;
            background: black;
            overflow: hidden;
            border-right: 5px solid #003a5f;
        }
        
        #publicidadeImg,
        #publicidadeVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        #ladoDireito {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #senhaAtual,
        #historico {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        #senhaAtual {
            background: #003a5f;
            color: white;
            text-align: center;
        }
        
        #senhaAtualTexto {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        #senhaAtualNumero {
            font-size: 96px;
            font-weight: 900;
            color: #ffcc00;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }
        
        #mesaAtual {
            font-size: 42px;
            font-weight: bold;
            margin-top: 20px;
        }
        
        #historicoTitulo {
            font-size: 28px;
            font-weight: bold;
            color: #003a5f;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #003a5f;
            padding-bottom: 5px;
        }
        
        #historicoList div {
            display: flex;
            justify-content: space-between;
            font-size: 22px;
            padding: 6px 10px;
            border-bottom: 1px dashed #ccc;
            text-transform: uppercase;
        }
        
        #rodape {
            height: 10vh;
            width: 100%;
            background: #212529;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 60px;
            box-sizing: border-box;
            font-size: 22px;
            letter-spacing: 0.5px;
            position: relative;
        }
        
        #fraseRodape {
            flex: 1;
            text-align: left;
        }
        
        #dataHoraRodape {
            position: relative;
            width: 350px;
            height: 28px;
            text-align: right;
        }
        
        #blocoDataHora,
        #blocoTemperatura {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            transition: opacity 1s ease-in-out;
        }
        
        .fade-in {
            opacity: 1;
            z-index: 1;
        }
        
        .fade-out {
            opacity: 0;
            z-index: 0;
        }
        
        .icon {
            margin-right: 5px;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
    <div id="cabecalho">
        <img src="./audio/logo.png" alt="Logo" />
    </div>

    <div id="main">
        <div id="ladoEsquerdo">
            <img id="publicidadeImg" alt="Publicidade" />
            <video id="publicidadeVideo" muted autoplay></video>
        </div>

        <div id="ladoDireito">
            <div id="senhaAtual">
                <div id="senhaAtualTexto">SENHA</div>
                <div id="senhaAtualNumero">----</div>
                <div id="mesaAtual">Cadeira --</div>
            </div>
            <div id="historico">
                <div id="historicoTitulo">√öLTIMAS CHAMADAS</div>
                <div id="historicoList"></div>
            </div>
        </div>
    </div>

    <div id="rodape">
        <div id="fraseRodape">Aguarde sua vez...</div>
        <div id="dataHoraRodape">
            <span id="blocoDataHora" class="fade-in">
                <span class="icon">üìÖ</span><span id="dataAtual"></span> |
            <span class="icon">‚è∞</span><span id="horaAtual"></span>
            </span>
            <span id="blocoTemperatura" class="fade-out">
                <span class="icon">üå°Ô∏è</span><span id="temperaturaLocal"></span>
            </span>
        </div>
    </div>

    <audio id="audioChamada" src="./audio/chamada.wav"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZ0P7nNu-yeN9zvthLIHpTVafYUlCWId0",
            authDomain: "aparecemdia.firebaseapp.com",
            projectId: "aparecemdia"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const database = firebase.database();

        const senhaNumeroEl = document.getElementById("senhaAtualNumero");
        const mesaEl = document.getElementById("mesaAtual");
        const historicoListEl = document.getElementById("historicoList");
        const audioChamada = document.getElementById("audioChamada");

        // Status online do painel
        const statusRef = database.ref("statusPainel");
        statusRef.set(true).catch(err => console.error("Erro ao marcar status online:", err));
        statusRef.onDisconnect().set(false).catch(err => console.error("Erro no onDisconnect:", err));

        // Atualiza√ß√£o de senhas
        let ultimaSenhaId = null;
        let ultimoReforco = null;

        db.collection("senhas")
            .where("status", "==", "chamado")
            .orderBy("horarioAtendimento", "desc")
            .limit(5)
            .onSnapshot(snapshot => {
                const docs = snapshot.docs;
                if (docs.length > 0) {
                    const atual = docs[0].data();
                    const docId = docs[0].id;

                    if (ultimaSenhaId !== docId || (atual.reforcarAudio && (!ultimoReforco || atual.reforcarAudio.toMillis() !== ultimoReforco))) {
                        senhaNumeroEl.innerText = atual.numero;
                        mesaEl.innerText = atual.Cadeira || "Cadeira --";
                        audioChamada.currentTime = 0;
                        audioChamada.play();
                        ultimaSenhaId = docId;
                        ultimoReforco = atual.reforcarAudio ? atual.reforcarAudio.toMillis() : null;
                    }
                }

                historicoListEl.innerHTML = "";
                docs.forEach(doc => {
                    const dado = doc.data();
                    const div = document.createElement("div");
                    div.innerHTML = `<span>Senha ${dado.numero}</span><span>${dado.Cadeira || "Cadeira ?"}</span>`;
                    historicoListEl.appendChild(div);
                });
            });

        function mostrarFallback() {
            const imgEl = document.getElementById("publicidadeImg");
            const videoEl = document.getElementById("publicidadeVideo");
            imgEl.src = "https://via.placeholder.com/800x450?text=Sem+publicidade+dispon%C3%ADvel";
            imgEl.style.display = "block";
            imgEl.style.opacity = 1;
            videoEl.style.display = "none";
            videoEl.style.opacity = 0;
        }

        async function carregarMidiasDoFirestore() {
            const imgEl = document.getElementById("publicidadeImg");
            const videoEl = document.getElementById("publicidadeVideo");

            const snapshot = await db.collection("midias")
                .where("ativo", "==", true)
                .orderBy("ordem")
                .get();

            const midias = snapshot.docs.map(doc => doc.data());
            if (midias.length === 0) return mostrarFallback();

            let index = 0;
            let videoPlayTimeout = null;

            async function mostrarMidia() {
                const midia = midias[index];
                const tipo = (midia.tipo || "").toLowerCase().trim();

                // reset visibilidade
                imgEl.style.opacity = 0;
                videoEl.style.opacity = 0;
                await new Promise(r => setTimeout(r, 1000));

                // cleanup handlers from previous media
                imgEl.onerror = null;
                videoEl.onerror = null;
                videoEl.onended = null;
                videoEl.onplaying = null;
                if (videoPlayTimeout) {
                    clearTimeout(videoPlayTimeout);
                    videoPlayTimeout = null;
                }

                if (tipo === "video") {
                    videoEl.loop = false;

                    imgEl.style.display = "none";
                    videoEl.src = midia.url;
                    videoEl.style.display = "block";
                    videoEl.load();

                    // If video errors to load/play, skip to next automatically
                    videoEl.onerror = () => {
                        console.error("Erro ao carregar/exibir v√≠deo:", midia.url);
                        // avan√ßar para a pr√≥xima m√≠dia
                        index = (index + 1) % midias.length;
                        // pequena espera para evitar loop instant√¢neo em caso de erro generalizado
                        setTimeout(mostrarMidia, 500);
                    };

                    // Safety: if video doesn't start playing within 5 seconds, consider it failed
                    videoEl.onplaying = () => {
                        if (videoPlayTimeout) {
                            clearTimeout(videoPlayTimeout);
                            videoPlayTimeout = null;
                        }
                    };



                    videoEl.style.opacity = 1;

                    registrarExibicao({
                        arquivo: midia.url.split("/").pop(),
                        tipo: "video",
                        nome: midia.nome || midia.titulo || midia.displayName || midia.url.split("/").pop()
                    });

                    videoEl.onended = () => {
                        index = (index + 1) % midias.length;
                        mostrarMidia();
                    };

                } else if (tipo === "imagem") {
                    // Tratamento de erro para imagens: se falhar, pula para a pr√≥xima
                    imgEl.onerror = () => {
                        console.error("Erro ao carregar imagem:", midia.url);
                        index = (index + 1) % midias.length;
                        setTimeout(mostrarMidia, 500);
                    };

                    videoEl.pause();
                    videoEl.style.display = "none";
                    imgEl.src = midia.url;
                    imgEl.style.display = "block";
                    imgEl.style.opacity = 1;

                    registrarExibicao({
                        arquivo: midia.url.split("/").pop(),
                        tipo: "imagem"
                    });

                    setTimeout(() => {
                        index = (index + 1) % midias.length;
                        mostrarMidia();
                    }, 25000);
                } else {
                    mostrarFallback();
                }
            }

            mostrarMidia();
        }

        // Atualiza√ß√£o de data/hora
        setInterval(() => {
            const agora = new Date();
            document.getElementById("dataAtual").innerText = agora.toLocaleDateString();
            document.getElementById("horaAtual").innerText = agora.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
        }, 1000);

        // Frases do rodap√©
        db.collection("config").doc("frases").get().then(doc => {
            const frases = doc.exists ? doc.data().frasesRodape || ["Aguarde sua vez..."] : ["Aguarde sua vez..."];
            let i = 0;
            setInterval(() => {
                document.getElementById("fraseRodape").innerText = frases[i];
                i = (i + 1) % frases.length;
            }, 10000);
        });

        // Altern√¢ncia entre Data/Hora e Temperatura
        const cidades = ["S√£o Paulo", "Santos", "Guaruj√°", "Bertioga", "S√£o Sebasti√£o", "Praia Grande", "Mongagu√°", "Ilha Comprida"];
        let cidadeIndex = 0;

        async function atualizarTemperatura() {
            const cidade = cidades[cidadeIndex];
            try {
                const res = await fetch(`https://wttr.in/${encodeURIComponent(cidade)}?format=%t`);
                const temp = await res.text();
                document.getElementById("temperaturaLocal").innerText = `${cidade}: ${temp.replace('+', '')}`;
            } catch {
                document.getElementById("temperaturaLocal").innerText = `${cidade}: N/A`;
            }
            cidadeIndex = (cidadeIndex + 1) % cidades.length;
        }

        atualizarTemperatura();
        setInterval(atualizarTemperatura, 60000);

        let mostrarDataHora = true;
        setInterval(() => {
            const blocoData = document.getElementById("blocoDataHora");
            const blocoTemp = document.getElementById("blocoTemperatura");

            if (mostrarDataHora) {
                blocoData.classList.replace("fade-in", "fade-out");
                blocoTemp.classList.replace("fade-out", "fade-in");
            } else {
                blocoTemp.classList.replace("fade-in", "fade-out");
                blocoData.classList.replace("fade-out", "fade-in");
            }
            mostrarDataHora = !mostrarDataHora;
        }, 10000);

        function registrarExibicao(dados) {
            const agora = new Date().toISOString();
            const registro = {
                arquivo: dados.arquivo, // ex: WZnWjfs.mp4
                nome: dados.nome || null, // ex: "Bruno Honda"
                tipo: dados.tipo,
                timestamp: agora,
                painel: "Painel01"
            };

            const historicoRef = firebase.database().ref("historicoExibicoes");
            historicoRef.push(registro)
                .then(() => console.log("‚úÖ Exibi√ß√£o registrada:", registro.nome || registro.arquivo))
                .catch(err => console.error("Erro ao registrar exibi√ß√£o:", err));
        }
        document.addEventListener("DOMContentLoaded", carregarMidiasDoFirestore);
    </script>
</body>

</html>